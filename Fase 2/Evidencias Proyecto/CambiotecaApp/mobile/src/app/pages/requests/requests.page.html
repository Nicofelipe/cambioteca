<ion-header>
    <ion-toolbar>
        <ion-buttons slot="start"><ion-back-button defaultHref="/home"></ion-back-button></ion-buttons>
        <ion-title>Solicitudes</ion-title>
    </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
    <div class="pad">
        <ion-segment [value]="tab()" (ionChange)="tab.set($any($event.detail.value))">
            <ion-segment-button value="recibidas">
                <ion-label>Recibidas ({{ recibidas().length }})</ion-label>
            </ion-segment-button>
            <ion-segment-button value="enviadas">
                <ion-label>Enviadas ({{ enviadas().length }})</ion-label>
            </ion-segment-button>
        </ion-segment>
    </div>

    <!-- Loading -->
    <ion-list inset="true" *ngIf="loading()">
        <ion-item *ngFor="let i of [1,2,3]">
            <ion-avatar slot="start" class="thumb"><ion-skeleton-text [animated]="true"
                    style="width:56px;height:80px"></ion-skeleton-text></ion-avatar>
            <ion-label>
                <h3><ion-skeleton-text [animated]="true" style="width:60%"></ion-skeleton-text></h3>
                <p><ion-skeleton-text [animated]="true" style="width:40%"></ion-skeleton-text></p>
                <p><ion-skeleton-text [animated]="true" style="width:70%"></ion-skeleton-text></p>
            </ion-label>
        </ion-item>
    </ion-list>

    <!-- Recibidas -->
    <ion-list inset="true" *ngIf="!loading() && tab()==='recibidas'">
        <ion-item button detail="true" *ngFor="let s of recibidas()" (click)="goDetail(s)">
            <ion-avatar slot="start" class="thumb"><img src="/assets/librodefecto.png" alt="libro" /></ion-avatar>
            <ion-label>
                <h3>Libro solicitado: {{ s.libro_deseado?.titulo }}</h3>
                <p class="muted">Usuario solicitante: {{ counterpartyName(s,'recibida') }}</p>

                <div class="meta">
                    <ion-chip [outline]="true" [color]="colorEstado(s.estado)">
                        <ion-icon name="pricetag-outline"></ion-icon>
                        <ion-label>Estado: {{ s.estado }}</ion-label>
                    </ion-chip>

                    <ion-badge color="tertiary" *ngIf="ofertasCount(s)">
                        Cantidad de ofertas: {{ ofertasCount(s) }}
                    </ion-badge>

                    <ion-badge color="success" *ngIf="(s.estado||'').toLowerCase()==='aceptada' && s.libro_aceptado">
                        Libro seleccionado: {{ s.libro_aceptado?.titulo }}
                    </ion-badge>

                    <ion-note>
                        <ion-icon name="time-outline"></ion-icon>
                        {{ s.actualizada_en || s.creada_en | date:'short' }}
                    </ion-note>
                </div>

                <div class="line2" *ngIf="(s.estado||'').toLowerCase()==='aceptada'">
                    <ion-icon name="location-outline"></ion-icon>
                    Fecha/hora/lugar:
                    {{ s.lugar_intercambio || 'A coordinar' }} •
                    <ng-container *ngIf="s.fecha_intercambio_pactada; else pendienteFecha">
                        {{ s.fecha_intercambio_pactada | date:'short' }}
                    </ng-container>
                    <ng-template #pendienteFecha>Pendiente</ng-template>
                </div>
            </ion-label>

            <ion-buttons slot="end" *ngIf="showChat(s)">
                <ion-button fill="outline" color="primary" (click)="openChat(s, $event)">
                    <ion-icon name="chatbubbles-outline"></ion-icon>
                </ion-button>
            </ion-buttons>
        </ion-item>

        <ion-item *ngIf="!recibidas().length">
            <ion-label class="muted">No tienes solicitudes recibidas.</ion-label>
        </ion-item>
    </ion-list>

    <!-- Enviadas -->
    <ion-list inset="true" *ngIf="!loading() && tab()==='enviadas'">
        <ion-item button detail="true" *ngFor="let s of enviadas()" (click)="goDetail(s)">
            <ion-avatar slot="start" class="thumb"><img src="/assets/librodefecto.png" alt="libro" /></ion-avatar>
            <ion-label>
                <h3>Libro solicitado: {{ s.libro_deseado?.titulo }}</h3>
                <p class="muted">Para: {{ counterpartyName(s,'enviada') }}</p>

                <div class="meta">
                    <ion-chip [outline]="true" [color]="colorEstado(s.estado)">
                        <ion-icon name="pricetag-outline"></ion-icon>
                        <ion-label>Estado: {{ s.estado }}</ion-label>
                    </ion-chip>

                    <ion-badge color="tertiary" *ngIf="ofertasCount(s)">
                        Cantidad de ofertas: {{ ofertasCount(s) }}
                    </ion-badge>

                    <ion-badge color="success" *ngIf="(s.estado||'').toLowerCase()==='aceptada' && s.libro_aceptado">
                        Libro seleccionado: {{ s.libro_aceptado?.titulo }}
                    </ion-badge>

                    <ion-note>
                        <ion-icon name="time-outline"></ion-icon>
                        {{ s.actualizada_en || s.creada_en | date:'short' }}
                    </ion-note>
                </div>

                <div class="line2" *ngIf="(s.estado||'').toLowerCase()==='aceptada'">
                    <ion-icon name="location-outline"></ion-icon>
                    Fecha/hora/lugar:
                    {{ s.lugar_intercambio || 'A coordinar' }} •
                    <ng-container *ngIf="s.fecha_intercambio_pactada; else pendiente2">
                        {{ s.fecha_intercambio_pactada | date:'short' }}
                    </ng-container>
                    <ng-template #pendiente2>Pendiente</ng-template>
                </div>
            </ion-label>

            <ion-buttons slot="end" *ngIf="showChat(s)">
                <ion-button fill="outline" color="primary" (click)="openChat(s, $event)">
                    <ion-icon name="chatbubbles-outline"></ion-icon>
                </ion-button>
            </ion-buttons>
        </ion-item>

        <ion-item *ngIf="!enviadas().length">
            <ion-label class="muted">No tienes solicitudes enviadas.</ion-label>
        </ion-item>
    </ion-list>
</ion-content>