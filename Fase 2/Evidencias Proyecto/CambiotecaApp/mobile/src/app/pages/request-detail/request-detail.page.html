<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start"><ion-back-button defaultHref="/requests"></ion-back-button></ion-buttons>
    <ion-title>Solicitud</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-list inset="true" *ngIf="row() as d; else loadingTpl">
    <!-- Encabezado con info principal -->
    <ion-item lines="full">
      <ion-avatar slot="start" class="thumb"><img src="/assets/librodefecto.png" /></ion-avatar>
      <ion-label>
        <h2>Libro solicitado: "{{ d.libro_deseado?.titulo }}"</h2>

        <!-- üëá Etiqueta din√°mica seg√∫n tu rol -->
        <p class="muted">
          {{ rol()==='recibida' ? 'Usuario solicitante' : 'Due√±o del libro solicitado' }}:
          <a class="link" (click)="goUser(rol()==='recibida' ? d.solicitante?.id_usuario : d.receptor?.id_usuario)">
            {{ rol()==='recibida' ? (d.solicitante?.nombre_usuario || '‚Äî') : (d.receptor?.nombre_usuario || '‚Äî') }}
          </a>
        </p>

        <div class="meta">
          <ion-chip [outline]="true" [color]="colorEstado(d.estado)">
            <ion-icon name="pricetag-outline"></ion-icon>
            <ion-label>Estado: {{ d.estado }}</ion-label>
          </ion-chip>

          <ion-badge color="tertiary" *ngIf="d.ofertas?.length">
            Cantidad de ofertas: {{ d.ofertas.length }}
          </ion-badge>

          <ion-badge color="success" *ngIf="esAceptada() && d.libro_aceptado">
            Libro seleccionado: {{ d.libro_aceptado?.titulo }}
          </ion-badge>

          <ion-note>
            <ion-icon name="time-outline"></ion-icon>
            {{ d.actualizada_en || d.creada_en | date:'short' }}
          </ion-note>
        </div>

        <!-- Fecha/hora/lugar -->
        <div class="line2" *ngIf="esAceptada()">
          <ion-icon name="location-outline"></ion-icon>
          Fecha/hora/lugar:
          {{ d.lugar_intercambio || 'A coordinar' }} ‚Ä¢
          <ng-container *ngIf="d.fecha_intercambio_pactada; else pendiente">
            {{ d.fecha_intercambio_pactada | date:'short' }}
          </ng-container>
          <ng-template #pendiente>Pendiente</ng-template>
        </div>
      </ion-label>

      <!-- Bot√≥n Chat fuera de la card -->
      <ion-buttons slot="end" *ngIf="d.conversacion_id">
        <ion-button fill="outline" color="primary" (click)="goChat()">
          <ion-icon slot="start" name="chatbubbles-outline"></ion-icon> Ver chat
        </ion-button>
      </ion-buttons>
    </ion-item>

    <!-- Aceptar (solo RECEPTOR y cuando est√° Pendiente) -->
    <ng-container *ngIf="puedeAceptar()">
      <ion-item lines="none">
        <ion-select placeholder="Selecciona libro" #sel>
          <ion-select-option *ngFor="let o of d.ofertas" [value]="+offeredId(o)">
            {{ offeredTitle(o) }}
          </ion-select-option>
        </ion-select>
        <ion-button slot="end" (click)="aceptar(sel.value)" [disabled]="!sel.value">
          Aceptar
        </ion-button>
      </ion-item>
    </ng-container>

    <!-- Rechazar/Cancelar (pendiente) -->
    <ion-item lines="none" *ngIf="esPendiente()">
      <ion-buttons slot="start" *ngIf="puedeRechazar()">
        <ion-button color="danger" fill="outline" (click)="rechazar()">
          <ion-icon slot="start" name="close-circle-outline"></ion-icon> Rechazar
        </ion-button>
      </ion-buttons>

      <ion-buttons slot="end" *ngIf="puedeCancelar()">
        <ion-button color="medium" fill="outline" (click)="cancelar()">
          <ion-icon slot="start" name="ban-outline"></ion-icon> Cancelar
        </ion-button>
      </ion-buttons>
    </ion-item>

    <!-- Reuni√≥n (editable solo por el RECEPTOR) -->
    <ng-container *ngIf="reunionVisible()">
      <ng-container *ngIf="puedeProponer(); else soloLecturaReunion">
        <ion-item>
          <ion-input label="Lugar" labelPlacement="floating" [(ngModel)]="lugar"></ion-input>
        </ion-item>
        <ion-item>
          <ion-input type="datetime-local" label="Fecha" labelPlacement="floating" [(ngModel)]="fecha"></ion-input>
        </ion-item>
        <div style="padding:8px 16px;">
          <ion-button (click)="proponer()">
            <ion-icon slot="start" name="calendar-outline"></ion-icon> Proponer
          </ion-button>
        </div>
      </ng-container>

      <ng-template #soloLecturaReunion>
        <ion-item>
          <ion-label>
            <div class="line2">
              <ion-icon name="location-outline"></ion-icon>
              Fecha/hora/lugar:
              {{ d.lugar_intercambio || 'A coordinar' }} ‚Ä¢
              <ng-container *ngIf="d.fecha_intercambio_pactada; else pendiente3">
                {{ d.fecha_intercambio_pactada | date:'short' }}
              </ng-container>
              <ng-template #pendiente3>Pendiente</ng-template>
            </div>
          </ion-label>
        </ion-item>
        <div style="padding:8px 16px;" *ngIf="puedeConfirmar()">
          <ion-button color="success" fill="outline" (click)="confirmar()">
            <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon> Confirmar
          </ion-button>
        </div>
      </ng-template>
    </ng-container>

    <!-- C√≥digo (sin bot√≥n de chat aqu√≠ adentro) -->
    <ion-card *ngIf="esAceptada()">
      <ion-card-header>
        <ion-card-title>C√≥digo de intercambio</ion-card-title>
        <ion-card-subtitle>
          {{ rol()==='recibida' ? 'Genera el c√≥digo y comp√°rtelo' : 'Ingresa el c√≥digo recibido' }}
        </ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <div *ngIf="puedeGenerar()">
          <ion-button (click)="generarCodigo()">
            <ion-icon slot="start" name="key-outline"></ion-icon> Generar c√≥digo
          </ion-button>
          <div class="codigo" *ngIf="codigoGenerado()">C√≥digo: <b>{{ codigoGenerado() }}</b></div>
        </div>

        <div *ngIf="puedeIngresar()" class="code-input">
          <ion-input placeholder="C√≥digo" [(ngModel)]="codigoIngresado"></ion-input>
          <ion-button color="success" (click)="completar()" [disabled]="!codigoIngresado">Completar</ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Resumen cuando est√° completado -->
    <ion-card *ngIf="d.fecha_completado">
      <ion-card-header>
        <ion-card-title>Intercambio completado</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p><b>Lugar de intercambio:</b> {{ d.lugar_intercambio || '‚Äî' }}</p>
        <p><b>Fecha de intercambio:</b> {{ d.fecha_completado | date:'short' }}</p>
        <p><b>Libro ofrecido:</b> {{ d.libro_aceptado?.titulo || '‚Äî' }}</p>
        <p><b>Libro solicitado:</b> {{ d.libro_deseado?.titulo || '‚Äî' }}</p>
        <ion-note>El chat est√° disponible para lectura, no podr√°s enviar nuevos mensajes.</ion-note>

        <!-- Bot√≥n de calificaci√≥n con modal -->
        <div style="margin-top:12px" *ngIf="puedeCalificar() && !yaCalifique()">
          <ion-button color="warning" (click)="openRating()">
            <ion-icon slot="start" name="star-outline"></ion-icon>
            Calificar usuario
          </ion-button>
        </div>
        <ion-note *ngIf="puedeCalificar() && yaCalifique()" style="display:block;margin-top:8px;">
          Ya calificaste este intercambio ‚úÖ
        </ion-note>
      </ion-card-content>
    </ion-card>

  </ion-list>

  <ng-template #loadingTpl>
    <ion-list inset="true">
      <ion-item>
        <ion-avatar slot="start" class="thumb"><ion-skeleton-text [animated]="true"
            style="width:56px;height:80px"></ion-skeleton-text></ion-avatar>
        <ion-label>
          <h3><ion-skeleton-text [animated]="true" style="width:60%"></ion-skeleton-text></h3>
          <p><ion-skeleton-text [animated]="true" style="width:40%"></ion-skeleton-text></p>
        </ion-label>
      </ion-item>
    </ion-list>
  </ng-template>

  <!-- ===== Modal de Calificaci√≥n ===== -->
  <ion-modal [isOpen]="ratingOpen()" (didDismiss)="ratingOpen.set(false)">
    <ng-template>
      <ion-header translucent>
        <ion-toolbar>
          <ion-title>Calificar usuario</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="ratingOpen.set(false)">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <ion-item>
          <ion-range min="1" max="5" step="1" snaps="true" ticks="true" [(ngModel)]="ratingVal">
            <ion-label slot="start">1</ion-label>
            <ion-label slot="end">5</ion-label>
          </ion-range>
        </ion-item>

        <ion-item>
          <ion-textarea autoGrow="true" label="Comentario (opcional)" labelPlacement="floating"
            placeholder="¬øC√≥mo fue la experiencia?" [(ngModel)]="ratingComment">
          </ion-textarea>
        </ion-item>

        <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end">
          <ion-button fill="outline" (click)="ratingOpen.set(false)">Cancelar</ion-button>
          <ion-button color="primary" (click)="confirmRating()">Enviar</ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>